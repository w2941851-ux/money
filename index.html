<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®°è´¦æœ¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-foreground: #ffffff;
      --secondary: #f1f5f9;
      --card: #ffffff;
      --card-foreground: #1e293b;
      --muted-foreground: #64748b;
      --border: #e2e8f0;
    }
    
    @keyframes bubble {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1.1); }
    }
    
    .animate-bubble {
      animation: bubble 0.3s ease-out forwards;
    }
    
    @keyframes ringGlow {
      0% { stroke-dasharray: 0 500; opacity: 0; }
      100% { opacity: 1; }
    }
    
    .activity-ring {
      animation: ringGlow 1s ease-out forwards;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body class="bg-slate-50">
  <div id="app"></div>

  <script type="module">
    // ======= ç±»ç›®é…ç½® =======
    const CATEGORY_GROUPS = [
      {
        id: "essential",
        name: "å¿…è¦å¼€æ”¯",
        color: "rgb(130, 200, 160)",
        glowColor: "rgba(130, 200, 160, 0.3)",
      },
      {
        id: "dining",
        name: "é¥®é£Ÿç”¨é¤",
        color: "rgb(230, 200, 120)",
        glowColor: "rgba(230, 200, 120, 0.3)",
      },
      {
        id: "entertainment",
        name: "ç”Ÿæ´»å¨±ä¹",
        color: "rgb(180, 160, 200)",
        glowColor: "rgba(180, 160, 200, 0.3)",
      },
    ];

    const EXPENSE_CATEGORIES = [
      { name: "äº¤é€š", icon: "ğŸš—", group: "essential", keywords: ["è½¦","äº¤é€š","æ‰“è½¦","å…¬äº¤","åœ°é“","å‡ºç§Ÿè½¦","æ»´æ»´","é«˜é“","ç«è½¦","é£æœº","æœºç¥¨","åŠ æ²¹","åœè½¦","è¿‡è·¯è´¹","å…±äº«å•è½¦","uber","æ²¹è´¹","è½¦è´¹","ç¥¨"] },
      { name: "ä½æˆ¿", icon: "ğŸ ", group: "essential", keywords: ["æˆ¿","ç§Ÿ","æˆ¿ç§Ÿ","æ°´è´¹","ç”µè´¹","ç‡ƒæ°”è´¹","ç‰©ä¸šè´¹","ç½‘è´¹","å®½å¸¦","è£…ä¿®","å®¶å±…","ç»´ä¿®","æ¸…æ´"] },
      { name: "é€šè®¯", icon: "ğŸ“±", group: "essential", keywords: ["è¯è´¹","æµé‡","æ‰‹æœºè´¹","ç”µè¯è´¹","å¥—é¤","å……å€¼","å®½å¸¦","ä¸Šç½‘","é€šä¿¡"] },
      { name: "åŒ»ç–—", icon: "ğŸ’Š", group: "essential", keywords: ["åŒ»","è¯","çœ‹ç—…","æŒ‚å·","ä½“æ£€","åŒ»é™¢","è¯Šæ‰€","æ²»ç–—","è¯åº—","ä¿å¥","å£è…”","ç‰™åŒ»","çœ¼é•œ","æŒ‰æ‘©","ç†ç–—"] },
      { name: "ä¿é™©", icon: "ğŸ›¡ï¸", group: "essential", keywords: ["ä¿é™©","ç¤¾ä¿","åŒ»ä¿","è½¦é™©","æ„å¤–é™©","å¯¿é™©","é‡ç–¾é™©","è´¢äº§é™©","ä¿è´¹"] },
      { name: "åŠå…¬", icon: "ğŸ’¼", group: "essential", keywords: ["åŠå…¬","æ–‡å…·","æ‰“å°","å¤å°","å¿«é€’","é‚®è´¹","ä¼šè®®","å‡ºå·®","å•†åŠ¡","ç¬”","æœ¬å­","æ–‡ä»¶å¤¹","è®¢ä¹¦æœº"] },
      { name: "é¤é¥®", icon: "ğŸœ", group: "dining", keywords: ["åƒ","é¤","é¥­","æ—©é¤","åˆé¤","æ™šé¤","å¤œå®µ","é›¶é£Ÿ","é¥®æ–™","å’–å•¡","å¥¶èŒ¶","ç«é”…","çƒ§çƒ¤","å¤–å–","é£Ÿå ‚","ç¾é£Ÿ","å°åƒ","å¿«é¤","è‡ªåŠ©é¤","ç‚¹å¿ƒ","ç”œå“","è›‹ç³•","é¢åŒ…","æ°´æœ","è‚‰","é±¼","è™¾","èŸ¹","é¸¡","é¸­","çŒª","ç‰›","ç¾Š","æ’éª¨","äº”èŠ±è‚‰","ç‰›æ’","é¸¡è…¿","é¸¡ç¿…","æµ·é²œ","è”¬èœ","é’èœ","é¢","ç²‰","ç±³","ç±³é¥­","é¢æ¡","ç²‰æ¡","æ‹‰é¢","é¥ºå­","åŒ…å­","é¦’å¤´","å¯¿å¸","æŠ«è¨","æ±‰å ¡","ç‚¸é¸¡","éº»è¾£çƒ«","å†’èœ","ä¸²ä¸²","ç‚’èœ","ç‚–","ç…®","ç…","ç‚’","è’¸","ç‚–æ±¤","ç²¥","èŒ¶","é…’","å•¤é…’","ç™½é…’","çº¢é…’","æœæ±","å¯ä¹","é›ªç¢§","è±†æµ†","ç‰›å¥¶","é…¸å¥¶","ä¹°èœ"] },
      { name: "å¨±ä¹", icon: "ğŸ®", group: "entertainment", keywords: ["ç©","å¨±ä¹","ç”µå½±","æ¸¸æˆ","KTV","å”±æ­Œ","é…’å§","èšä¼š","é—¨ç¥¨","ä¼šå‘˜","å……å€¼"] },
      { name: "è´­ç‰©", icon: "ğŸ›ï¸", group: "entertainment", keywords: ["ä¹°","è´­","æ·˜å®","äº¬ä¸œ","æ‹¼å¤šå¤š","å•†åœº","è¶…å¸‚","ç½‘è´­","è¡£æœ","é‹","åŒ…","åŒ–å¦†å“","æŠ¤è‚¤","æ‰‹æœº","ç”µè„‘","æ•°ç ","ç”µå™¨","å®¶å…·","æ—¥ç”¨å“","ç”Ÿæ´»ç”¨å“"] },
      { name: "æœé¥°", icon: "ğŸ‘”", group: "entertainment", keywords: ["è¡£","æœ","è£¤","è£™","å¤–å¥—","Tæ¤","å«è¡£","ç¾½ç»’æœ","è¥¿è£…","é‹å­","è¿åŠ¨é‹","çš®é‹","å‡‰é‹","æ‹–é‹","è¢œå­","å¸½å­","å›´å·¾","æ‰‹å¥—"] },
      { name: "ç¾å®¹", icon: "ğŸ’„", group: "entertainment", keywords: ["ç¾å®¹","ç¾å‘","ç†å‘","æŸ“å‘","çƒ«å‘","é€ å‹","ç¾ç”²","æŠ¤è‚¤","é¢è†œ","ç²¾å","é˜²æ™’","æ´—é¢å¥¶","æ°´ä¹³","åŒ–å¦†","å£çº¢","ç²‰åº•","çœ¼å½±","spa"] },
      { name: "æ•°ç ", icon: "ğŸ’»", group: "entertainment", keywords: ["ç”µè„‘","æ‰‹æœº","å¹³æ¿","ipad","è€³æœº","éŸ³å“","é”®ç›˜","é¼ æ ‡","æ˜¾ç¤ºå™¨","ç›¸æœº","é•œå¤´","å……ç”µå™¨","æ•°æ®çº¿","ç¡¬ç›˜","uç›˜"] },
      { name: "è¿åŠ¨", icon: "âš½", group: "entertainment", keywords: ["è¿åŠ¨","å¥èº«","è·‘æ­¥","ç‘œä¼½","æ¸¸æ³³","çƒ","ç¾½æ¯›çƒ","ç¯®çƒ","è¶³çƒ","ä¹’ä¹“çƒ","ç½‘çƒ","è£…å¤‡","è¿åŠ¨æœ","çƒé‹","å¥èº«å¡"] },
      { name: "æ—…è¡Œ", icon: "âœˆï¸", group: "entertainment", keywords: ["æ—…æ¸¸","æ—…è¡Œ","é…’åº—","ä½å®¿","æ°‘å®¿","æœºç¥¨","è½¦ç¥¨","æ™¯ç‚¹","é—¨ç¥¨","å¯¼æ¸¸","ç­¾è¯","ä¿é™©","è¡Œæ","èƒŒåŒ…"] },
      { name: "ç¤¾äº¤", icon: "ğŸ‘¥", group: "entertainment", keywords: ["è¯·å®¢","èšé¤","ç¤¼ç‰©","çº¢åŒ…","ä»½å­é’±","èšä¼š","é€ç¤¼","è¯·äºº","äººæƒ…","å®´è¯·","ç”Ÿæ—¥","ç»“å©š","æ»¡æœˆ"] },
      { name: "å® ç‰©", icon: "ğŸ¾", group: "entertainment", keywords: ["å® ç‰©","çŒ«","ç‹—","ç‹—ç²®","çŒ«ç²®","å® ç‰©åŒ»é™¢","å® ç‰©åº—","æ´—æ¾¡","ç¾å®¹","ç©å…·","é›¶é£Ÿ","ç”¨å“"] },
      { name: "å­©å­", icon: "ğŸ‘¶", group: "entertainment", keywords: ["å­©å­","å®å®","å©´å„¿","å¥¶ç²‰","å°¿å¸ƒ","çº¸å°¿è£¤","ç©å…·","ç«¥è£…","ç«¥é‹","æ—©æ•™","å¹¼å„¿å›­","å­¦è´¹","å…´è¶£ç­","å¥¶ç“¶","æ¨è½¦"] },
      { name: "å­¦ä¹ ", icon: "ğŸ“š", group: "entertainment", keywords: ["å­¦","è¯¾","åŸ¹è®­","æ•™è‚²","ä¹¦","è¯¾ç¨‹","å­¦è´¹","åŸ¹è®­è´¹","è¡¥ä¹ ","ç½‘è¯¾","è¯ä¹¦","è€ƒè¯•","æ•™æ","æ–‡å…·","ç¬”è®°æœ¬"] },
      { name: "æèµ ", icon: "â¤ï¸", group: "entertainment", keywords: ["æ","ææ¬¾","æèµ ","å…¬ç›Š","æ…ˆå–„","çˆ±å¿ƒ","å‹Ÿæ","ä¹‰å–","æ•‘åŠ©"] },
      { name: "å…¶ä»–", icon: "ğŸ“¦", group: "entertainment", keywords: ["å…¶ä»–","æ‚è´¹","é›¶æ•£"] },
    ];

    function matchCategory(description) {
      const lowerDesc = description.toLowerCase();
      for (const category of EXPENSE_CATEGORIES) {
        for (const keyword of category.keywords) {
          if (lowerDesc.includes(keyword)) {
            return category.name;
          }
        }
      }
      return null;
    }

    function getCategoryGroup(categoryName) {
      const category = EXPENSE_CATEGORIES.find(c => c.name === categoryName);
      const group = category?.group || "essential";
      return CATEGORY_GROUPS.find(g => g.id === group) || CATEGORY_GROUPS[0];
    }

    // ======= åº”ç”¨çŠ¶æ€ =======
    const STORAGE_KEY = "expense-tracker-data";
    let state = {
      expenses: JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'),
      view: 'list', // 'list', 'form', 'voice'
      showRings: false,
      showAddMenu: false,
      formData: { amount: '', description: '', category: '' },
      voiceData: { isListening: false, transcript: '', parsedExpenses: [] },
      swipeState: { swipedId: null, startX: 0, currentX: 0, isDragging: false }
    };

    let recognition = null;

    // ======= åˆå§‹åŒ–è¯­éŸ³è¯†åˆ« =======
    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'zh-CN';

        recognition.onresult = (event) => {
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            }
          }
          state.voiceData.transcript += finalTranscript;
          render();
        };

        recognition.onerror = (event) => {
          console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
          state.voiceData.isListening = false;
          render();
        };

        recognition.onend = () => {
          state.voiceData.isListening = false;
          render();
        };
      }
    }

    // ======= æ ¸å¿ƒå‡½æ•° =======
    function saveExpenses() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.expenses));
    }

    function addExpense(expense) {
      state.expenses.unshift({ ...expense, id: Date.now().toString() });
      saveExpenses();
      state.view = 'list';
      render();
    }

    function addBatchExpenses(batchExpenses) {
      const newExpenses = batchExpenses.map((expense, index) => {
        const categoryData = EXPENSE_CATEGORIES.find(c => c.name === expense.category) || EXPENSE_CATEGORIES[EXPENSE_CATEGORIES.length - 1];
        return {
          id: (Date.now() + index).toString(),
          amount: expense.amount,
          category: expense.category,
          description: expense.description,
          date: new Date().toISOString(),
          icon: categoryData.icon,
        };
      });
      state.expenses = [...newExpenses, ...state.expenses];
      saveExpenses();
      state.view = 'list';
      render();
    }

    function deleteExpense(id) {
      state.expenses = state.expenses.filter(e => e.id !== id);
      saveExpenses();
      render();
    }

    function toggleListening() {
      if (!recognition) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
        return;
      }

      if (state.voiceData.isListening) {
        recognition.stop();
        parseTranscript(state.voiceData.transcript);
      } else {
        state.voiceData.transcript = '';
        state.voiceData.parsedExpenses = [];
        recognition.start();
        state.voiceData.isListening = true;
      }
      render();
    }

    function parseTranscript(text) {
      const expenses = [];
      const normalizedText = text.replace(/è¿˜æœ‰|ç„¶å|æ¥ç€|å¦å¤–/g, '|').replace(/[ï¼Œ,ã€‚ï¼›;ã€]/g, '|');
      const segments = normalizedText.split('|').map(s => s.trim()).filter(s => s.length > 0);

      for (const segment of segments) {
        const cleanSegment = segment.replace(/\s+/g, '');
        if (!cleanSegment) continue;

        let matched = false;
        let description = '';
        let amount = 0;

        const pattern1 = /^([^\d]+?)(\d+(?:\.\d+)?)(å…ƒ|å—|å—é’±|åœ†)?$/;
        const match1 = cleanSegment.match(pattern1);
        if (match1) {
          description = match1[1];
          amount = parseFloat(match1[2]);
          matched = true;
        }

        if (!matched) {
          const pattern2 = /^(\d+(?:\.\d+)?)(å…ƒ|å—|å—é’±|åœ†)?([^\d]+?)$/;
          const match2 = cleanSegment.match(pattern2);
          if (match2) {
            amount = parseFloat(match2[1]);
            description = match2[3];
            matched = true;
          }
        }

        if (!matched) {
          const pattern3 = /([^\d]*?)(\d+(?:\.\d+)?)(å…ƒ|å—|å—é’±|åœ†)?([^\d]*)/;
          const match3 = cleanSegment.match(pattern3);
          if (match3) {
            const beforeNum = match3[1] || '';
            const afterNum = match3[4] || '';
            description = (beforeNum + afterNum).replace(/ä¹°äº†|ä¹°|èŠ±äº†|èŠ±|äº†/g, '').trim();
            amount = parseFloat(match3[2]);
            if (description) matched = true;
          }
        }

        if (matched && !isNaN(amount) && amount > 0 && description) {
          description = description.replace(/ä¹°äº†|ä¹°|èŠ±äº†|èŠ±|ç”¨äº†|ç”¨|çš„|ä¸€ä¸ª|ä¸€ä»½|äº†/g, '').trim();
          if (description) {
            const category = matchCategory(description) || 'å…¶ä»–';
            expenses.push({ amount, description, category });
          }
        }
      }

      state.voiceData.parsedExpenses = expenses;
      render();
    }

    // ======= æ¸²æŸ“å‡½æ•° =======
    function render() {
      const app = document.getElementById('app');
      const totalExpense = state.expenses.reduce((sum, e) => sum + e.amount, 0);
      const currentMonth = new Date().toLocaleDateString('zh-CN', { month: 'long' });

      // è®¡ç®—åˆ†ç±»ç»Ÿè®¡
      const categoryStats = CATEGORY_GROUPS.map(group => {
        const groupExpenses = state.expenses.filter(expense => {
          const expenseGroup = getCategoryGroup(expense.category);
          return expenseGroup.id === group.id;
        });
        const total = groupExpenses.reduce((sum, expense) => sum + expense.amount, 0);
        const percentage = totalExpense > 0 ? (total / totalExpense) * 100 : 0;
        return { ...group, total, percentage };
      });

      app.innerHTML = `
        <div class="mx-auto max-w-md min-h-screen flex flex-col bg-slate-50">
          <!-- Header -->
          <div class="bg-indigo-500 text-white px-6 py-8 rounded-b-[2rem]">
            <div class="flex items-center justify-between mb-8">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                  </svg>
                </div>
                <h1 class="text-xl font-semibold">è®°è´¦æœ¬</h1>
              </div>
              <button onclick="toggleRings()" class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm hover:bg-white/20 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </button>
            </div>

            ${state.showRings ? renderActivityRings(categoryStats, currentMonth) : ''}

            <!-- Summary -->
            <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-5">
              <div class="flex items-center justify-between mb-3">
                <span class="text-white/70 text-sm">æœ¬æœˆæ”¯å‡º</span>
                <div class="flex items-center gap-1.5 text-white/70 text-xs">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                  </svg>
                  <span>${currentMonth}</span>
                </div>
              </div>
              <div class="flex items-baseline gap-2">
                <span class="text-3xl font-bold text-white">Â¥${totalExpense.toFixed(2)}</span>
              </div>
              <div class="mt-3 text-white/60 text-xs">å…± ${state.expenses.length} ç¬”æ”¯å‡º</div>

              ${state.expenses.length > 0 ? `
                <div class="mt-4 pt-4 border-t border-white/10 space-y-2">
                  ${categoryStats.map(stat => `
                    <div class="flex items-center justify-between text-xs">
                      <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full" style="background-color: ${stat.color}; box-shadow: 0 0 8px ${stat.glowColor};"></div>
                        <span class="text-white/80">${stat.name}</span>
                      </div>
                      <span class="text-white/90 font-medium">Â¥${stat.total.toFixed(2)}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>

          <!-- Content -->
          <div class="flex-1 px-6 py-6">
            ${state.view === 'form' ? renderForm() : state.view === 'voice' ? renderVoice() : renderList()}
          </div>
        </div>
      `;

      attachEventListeners();
    }

    function renderActivityRings(categoryStats, currentMonth) {
      const foodStat = categoryStats.find(s => s.id === 'dining') || categoryStats[0];
      const lifeStat = categoryStats.find(s => s.id === 'entertainment') || categoryStats[1];
      const essentialStat = categoryStats.find(s => s.id === 'essential') || categoryStats[2];

      return `
        <div class="bg-white/30 backdrop-blur-md rounded-2xl p-5 border border-white/40 shadow-lg mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-sm">æ”¯å‡ºåˆ†æ</h3>
            <span class="text-xs opacity-70">${currentMonth}</span>
          </div>

          <div class="relative w-40 h-40 mx-auto mb-5">
            <svg class="absolute inset-0 -rotate-90" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="70" fill="none" stroke="currentColor" stroke-width="12" class="opacity-10"/>
              <circle cx="80" cy="80" r="70" fill="none" stroke="${essentialStat.color}" stroke-width="12" stroke-linecap="round" 
                stroke-dasharray="${(439.6 * essentialStat.percentage) / 100} 439.6" 
                style="filter: drop-shadow(0 0 6px ${essentialStat.glowColor})" class="activity-ring"/>
            </svg>

            <svg class="absolute inset-0 -rotate-90" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="56" fill="none" stroke="currentColor" stroke-width="12" class="opacity-10"/>
              <circle cx="80" cy="80" r="56" fill="none" stroke="${lifeStat.color}" stroke-width="12" stroke-linecap="round" 
                stroke-dasharray="${(351.7 * lifeStat.percentage) / 100} 351.7" 
                style="filter: drop-shadow(0 0 6px ${lifeStat.glowColor})" class="activity-ring"/>
            </svg>

            <svg class="absolute inset-0 -rotate-90" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="42" fill="none" stroke="currentColor" stroke-width="12" class="opacity-10"/>
              <circle cx="80" cy="80" r="42" fill="none" stroke="${foodStat.color}" stroke-width="12" stroke-linecap="round" 
                stroke-dasharray="${(263.8 * foodStat.percentage) / 100} 263.8" 
                style="filter: drop-shadow(0 0 6px ${foodStat.glowColor})" class="activity-ring"/>
            </svg>

            <div class="absolute inset-0 flex items-center justify-center">
              <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="space-y-2.5">
            ${categoryStats.map(stat => `
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="w-3 h-3 rounded-full" style="background-color: ${stat.color}; box-shadow: 0 0 8px ${stat.glowColor};"></div>
                  <span class="text-xs opacity-70">${stat.name}</span>
                </div>
                <span class="text-xs font-medium">Â¥${stat.total.toFixed(0)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderList() {
      return `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold text-slate-700">æ”¯å‡ºè®°å½•</h2>
          <div class="relative">
            <button onclick="toggleAddMenu()" class="flex items-center gap-2 px-5 py-2.5 bg-indigo-500 text-white rounded-xl font-medium hover:opacity-90 transition-opacity">
              + è®°ä¸€ç¬”
              <svg class="w-4 h-4 transition-transform ${state.showAddMenu ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>

            ${state.showAddMenu ? `
              <div class="absolute right-0 top-full mt-2 w-40 bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden z-10">
                <button onclick="showForm()" class="w-full px-4 py-3 text-left text-sm text-slate-700 hover:bg-slate-100 transition-colors">
                  æ‰‹åŠ¨è¾“å…¥
                </button>
                <button onclick="showVoice()" class="w-full px-4 py-3 text-left text-sm text-slate-700 hover:bg-slate-100 transition-colors border-t border-slate-200">
                  ä¸€å£æ°”è¯´å®Œ
                </button>
              </div>
            ` : ''}
          </div>
        </div>

        ${state.expenses.length === 0 ? `
          <div class="text-center py-16">
            <div class="w-20 h-20 bg-slate-200 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
              </svg>
            </div>
            <p class="text-slate-500 text-sm">è¿˜æ²¡æœ‰æ”¯å‡ºè®°å½•</p>
            <p class="text-slate-400 text-xs mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è®°è´¦</p>
          </div>
        ` : `
          <div class="space-y-3">
            ${state.expenses.map(expense => renderExpenseItem(expense)).join('')}
          </div>
        `}
      `;
    }

    function renderExpenseItem(expense) {
      const formatDate = (dateString) => {
        const date = new Date(dateString);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) return 'ä»Šå¤©';
        if (date.toDateString() === yesterday.toDateString()) return 'æ˜¨å¤©';
        return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
      };

      const offset = state.swipeState.swipedId === expense.id && state.swipeState.isDragging ? state.swipeState.currentX : 0;

      return `
        <div class="relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-l from-red-500/20 to-transparent rounded-2xl flex items-center justify-end pr-6">
            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </div>

          <div 
            class="bg-white rounded-2xl p-4 border border-slate-200 hover:shadow-sm transition-all relative cursor-pointer"
            style="transform: translateX(-${offset}px); transition: ${state.swipeState.isDragging ? 'none' : 'transform 0.3s ease-out'};"
            data-expense-id="${expense.id}"
            ontouchstart="handleTouchStart(event, '${expense.id}')"
            ontouchmove="handleTouchMove(event)"
            ontouchend="handleTouchEnd('${expense.id}')"
          >
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                <span class="text-2xl">${expense.icon}</span>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2 mb-1">
                  <h4 class="font-medium text-slate-700 truncate">${expense.description}</h4>
                  <span class="text-lg font-semibold text-slate-700 whitespace-nowrap">Â¥${expense.amount.toFixed(2)}</span>
                </div>
                <div class="flex items-center justify-between gap-2">
                  <span class="text-xs text-slate-500">${expense.category}</span>
                  <span class="text-xs text-slate-500">${formatDate(expense.date)}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderForm() {
      const suggestedCategory = state.formData.description && !state.formData.category 
        ? matchCategory(state.formData.description) 
        : null;

      return `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
          <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
            <h3 class="font-semibold text-slate-700">æ·»åŠ æ”¯å‡º</h3>
            <button onclick="cancelForm()" class="text-slate-400 hover:text-slate-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <form onsubmit="submitForm(event)" class="p-5 space-y-5">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">é‡‘é¢</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-lg">Â¥</span>
                <input type="number" step="0.01" value="${state.formData.amount}" oninput="updateFormAmount(this.value)" 
                  placeholder="0.00" required
                  class="w-full pl-10 pr-4 py-3 bg-slate-100 rounded-xl border-0 text-lg font-semibold text-slate-700 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                æè¿°
                ${suggestedCategory ? `<span class="text-indigo-500 text-xs ml-2">ğŸ’¡ ä¸ºä½ æ¨èï¼š${suggestedCategory}</span>` : ''}
              </label>
              <input type="text" value="${state.formData.description}" oninput="updateFormDescription(this.value)" 
                placeholder="ä»Šå¤©ä¹°äº†ä»€ä¹ˆï¼Ÿ" required
                class="w-full px-4 py-3 bg-slate-100 rounded-xl border-0 text-slate-700 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-3">é€‰æ‹©ç±»ç›®</label>
              <div class="grid grid-cols-4 gap-3">
                ${EXPENSE_CATEGORIES.map(category => {
                  const isSelected = state.formData.category === category.name || (!state.formData.category && suggestedCategory === category.name);
                  return `
                    <button type="button" onclick="selectCategory('${category.name}')"
                      class="flex flex-col items-center gap-2 p-3 rounded-xl transition-all duration-300 ${
                        isSelected 
                          ? 'bg-indigo-500 text-white shadow-sm scale-110 animate-bubble' 
                          : 'bg-slate-100 text-slate-700 hover:bg-slate-200 hover:scale-105'
                      }">
                      <span class="text-2xl">${category.icon}</span>
                      <span class="text-xs font-medium">${category.name}</span>
                    </button>
                  `;
                }).join('')}
              </div>
            </div>

            <button type="submit" class="w-full py-3.5 bg-indigo-500 text-white rounded-xl font-semibold hover:opacity-90 transition-opacity">
              æ·»åŠ è®°å½•
            </button>
          </form>
        </div>
      `;
    }

    function renderVoice() {
      return `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
          <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
            <h3 class="font-semibold text-slate-700">ä¸€å£æ°”è¯´å®Œ</h3>
            <button onclick="cancelVoice()" class="text-slate-400 hover:text-slate-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="p-5 space-y-5">
            <div class="flex flex-col items-center gap-4">
              <button onclick="toggleListening()" class="w-24 h-24 rounded-full flex items-center justify-center transition-all ${
                state.voiceData.isListening 
                  ? 'bg-red-500 text-white animate-pulse shadow-lg' 
                  : 'bg-indigo-500 text-white hover:opacity-90'
              }">
                ${state.voiceData.isListening ? `
                  <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                  </svg>
                ` : `
                  <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                  </svg>
                `}
              </button>
              <p class="text-sm text-slate-500 text-center">
                ${state.voiceData.isListening ? 'æ­£åœ¨è†å¬...è¯´å®Œåç‚¹å‡»åœæ­¢' : 'ç‚¹å‡»éº¦å…‹é£å¼€å§‹è¯­éŸ³å½•å…¥'}
              </p>
              <p class="text-xs text-slate-400 text-center px-4">ç¤ºä¾‹ï¼šæ—©é¤20å…ƒï¼Œåˆé¤35å—ï¼Œæ‰“è½¦15å…ƒ</p>
            </div>

            ${state.voiceData.transcript ? `
              <div class="bg-slate-100 rounded-xl p-4">
                <p class="text-sm text-slate-700">${state.voiceData.transcript}</p>
              </div>
            ` : ''}

            ${state.voiceData.parsedExpenses.length > 0 ? `
              <div class="space-y-3">
                <h4 class="text-sm font-medium text-slate-700">è¯†åˆ«åˆ° ${state.voiceData.parsedExpenses.length} ç¬”æ”¯å‡ºï¼š</h4>
                ${state.voiceData.parsedExpenses.map((expense, index) => `
                  <div class="flex items-center justify-between bg-slate-100 rounded-xl p-3">
                    <div class="flex-1">
                      <p class="text-sm font-medium text-slate-700">${expense.description}</p>
                      <p class="text-xs text-slate-500 mt-1">Â¥${expense.amount.toFixed(2)} Â· ${expense.category}</p>
                    </div>
                    <button onclick="removeVoiceExpense(${index})" class="text-slate-400 hover:text-red-500 ml-2">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                `).join('')}

                <button onclick="submitVoice()" class="w-full py-3.5 bg-indigo-500 text-white rounded-xl font-semibold hover:opacity-90 transition-opacity">
                  ç¡®è®¤è®°å½•ï¼ˆ${state.voiceData.parsedExpenses.length} ç¬”ï¼‰
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function attachEventListeners() {
      // Touch events are handled inline via ontouchstart/move/end attributes
    }

    // ======= å…¨å±€å‡½æ•° =======
    window.toggleRings = () => {
      state.showRings = !state.showRings;
      render();
    };

    window.toggleAddMenu = () => {
      state.showAddMenu = !state.showAddMenu;
      render();
    };

    window.showForm = () => {
      state.view = 'form';
      state.showAddMenu = false;
      state.formData = { amount: '', description: '', category: '' };
      render();
    };

    window.showVoice = () => {
      state.view = 'voice';
      state.showAddMenu = false;
      state.voiceData = { isListening: false, transcript: '', parsedExpenses: [] };
      render();
    };

    window.cancelForm = () => {
      state.view = 'list';
      render();
    };

    window.cancelVoice = () => {
      if (state.voiceData.isListening && recognition) {
        recognition.stop();
      }
      state.view = 'list';
      render();
    };

    window.updateFormAmount = (value) => {
      state.formData.amount = value;
    };

    window.updateFormDescription = (value) => {
      state.formData.description = value;
      render();
    };

    window.selectCategory = (category) => {
      state.formData.category = category;
      render();
    };

    window.submitForm = (event) => {
      event.preventDefault();
      const finalCategory = state.formData.category || matchCategory(state.formData.description) || 'å…¶ä»–';
      const categoryData = EXPENSE_CATEGORIES.find(c => c.name === finalCategory) || EXPENSE_CATEGORIES[EXPENSE_CATEGORIES.length - 1];

      addExpense({
        amount: parseFloat(state.formData.amount),
        category: finalCategory,
        description: state.formData.description,
        date: new Date().toISOString(),
        icon: categoryData.icon,
      });
    };

    window.submitVoice = () => {
      addBatchExpenses(state.voiceData.parsedExpenses);
    };

    window.removeVoiceExpense = (index) => {
      state.voiceData.parsedExpenses.splice(index, 1);
      render();
    };

    window.handleTouchStart = (e, id) => {
      state.swipeState.startX = e.touches[0].clientX;
      state.swipeState.swipedId = id;
      state.swipeState.isDragging = true;
      render();
    };

    window.handleTouchMove = (e) => {
      if (!state.swipeState.isDragging) return;
      const deltaX = state.swipeState.startX - e.touches[0].clientX;
      if (deltaX > 0) {
        state.swipeState.currentX = Math.min(deltaX, 80);
        render();
      }
    };

    window.handleTouchEnd = (id) => {
      state.swipeState.isDragging = false;
      if (state.swipeState.currentX > 60) {
        deleteExpense(id);
      }
      state.swipeState.currentX = 0;
      state.swipeState.startX = 0;
      render();
    };

    // ======= åˆå§‹åŒ– =======
    initSpeechRecognition();
    render();
  </script>
</body>
</html>
